{% extends 'template.html' %}
{% block css %}
	<link href="/static/css/links.css?v={{ version }}" rel="stylesheet">
{% endblock %}
{% block content %}
	<div class="modal fade" id="addLinkModal" tabindex="-1" aria-labelledby="addLinkLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="addLinkLabel">Ajouter</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="input-group mb-3">
						<span class="input-group-text" id="loginAddon">Login</span>
						<input autofocus list="suggestions" type="text" class="form-control" id="addLinkInput"
						       aria-label="Login42" aria-describedby="loginAddon" placeholder="login1, login2, login3">
						<datalist id="suggestions"></datalist>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<button type="button" class="btn btn-primary" id="addLinkButton">
						<i class="fa-solid fa-user-plus"></i> <i hidden class="spinner-border spinner-border-sm"></i>
						Ajouter
					</button>
				</div>
			</div>
		</div>
	</div>

	{% include 'open_modal.html' %}
	
	<div class="text-center lead">
		{{ relation_name }}
	</div>
	<div class="container">
		<div class="row text-center justify-content-center">
			{% for link in links %}
				<div id="case-{{ link.name }}" class="card shadow m-2 pl-fix card-size grow"
				     onclick="openLink('{{ link.name }}', true)">
					<img src="{{ proxy_images(link.custom_image_link if link.custom_image_link else link.image_medium) }}" class="m-1 card-img-top card-img-size"
					     alt="{{ link.name }}'s image">
					<div class="card-body">
						<span class="badge badge-sm align-vertical bg-info text-dark">{{ link.tag | safe }}</span>
						<span class="badge badge-sm align-vertical bg-danger text-dark">{{ link.admin.tag | safe }}</span>
						<h5 class="card-title">
							<i class="fa-solid {{ "fa-2xs fa-circle online" if link.position else "fa-xs fa-person-walking offline" }}"></i> {{ link.name }}
						</h5>
						<p class="card-text">{{ link.position if link.position else 'Absent' }} {{ link.last_active }}
							{% if link.position %}
								<a class="fa-solid fa-users-viewfinder" href="/goto/{{ link.position }}"></a>
							{% endif %}
						</p>
					</div>
				</div>
			{% endfor %}
			{% if add %}
				<div class="card p-0 m-2 shadow card-size grow" onclick="openAddLink();">
					<div class="m-1 w-100 card-img-top text-center card-not-img-size">
						<i class="fa-solid fa-plus fa-5x"></i>
					</div>
					<div class="card-body">
						<h5 class="card-title">Ajouter</h5>
					</div>
				</div>
			{% endif %}
		</div>
	</div>


{% endblock %}

{% block scripts %}
	<script>
		let openAddLinkModal;
		let openLinkModal;
		let addLinkInput = document.getElementById('addLinkInput');
		let addLinkButton = document.getElementById('addLinkButton');

		function fillSuggestions(element, suggestions) {
			let list = document.querySelector(element);

			list.innerHTML = ''
			suggestions.forEach(function (item) {
				if (item['type'] !== "user") return;
				let option = document.createElement('option');
				option.value = item['v'];
				list.appendChild(option);
			});
		}

		function openAddLink() {
			const modal = new bootstrap.Modal('#addLinkModal', {});
			openAddLinkModal = modal;
			modal.show();
			setTimeout(() => {
				addLinkInput.focus();
				addLinkInput.select();
			}, 500)
		}

		async function deleteLocalLink() {
			let link_name = document.getElementById('openLinkLabel').innerText.trim();
			let resp = await deleteLink(link_name, "#deleteLink")
			if (resp === 200) {
				openLinkModal.hide();
				document.getElementById('case-' + link_name).remove();
			}
		}

		addLinkInput.addEventListener('keyup', function (key) {
			let name = addLinkInput.value.trim().toLowerCase();

			if (key.key === 'Enter') {
				if (name.length <= 3) {
					addLinkInput.focus();
					return;
				}
				addLink(name, '#addLinkButton', true);
				fillSuggestions('#suggestions', []);
			}
			if (name.trim() === '') return fillSuggestions('#suggestions', []);
			if (name.length < 3) return;
			setTimeout(() => {
				if (name !== addLinkInput.value) return;
				fetch('/search/' + encodeURIComponent(name) + "/1").then((response) => {
					response.json().then((json) => {
						fillSuggestions('#suggestions', json)
					})
				})
			}, 200)
		})

		addLinkButton.addEventListener('click', function () {
			let val = addLinkInput.value.trim().toLowerCase();
			if (val.length <= 3) {
				addLinkInput.focus();
				return;
			}
			addLink(val, {{ relation }},'#addLinkButton', true)
		})
	</script>
{% endblock %}
